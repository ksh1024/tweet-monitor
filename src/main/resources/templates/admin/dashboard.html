<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>트위터 모니터링 관리자 페이지</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 font-sans leading-normal tracking-normal">
<div class="container mx-auto p-4">
  <h1 class="text-3xl font-bold text-gray-800 mb-6">트위터 모니터링 관리자 대시보드</h1>
  <div class="bg-white shadow-md rounded-lg p-6 mb-8">
    <h2 class="text-2xl font-semibold text-gray-700 mb-4">키워드별 DM 수신자 목록</h2>
    <div th:if="${groupedMappings.isEmpty()}" class="text-gray-500 mb-4">매핑된 키워드-수신자 정보가 없습니다.</div>
    <div th:each="entry : ${groupedMappings}" class="mb-6 border border-gray-200 rounded-lg p-4">
      <h3 class="text-xl font-semibold text-gray-800 mb-2">
        <span th:text="${entry.key}" class="text-blue-600">키워드 텍스트</span>
        (<span th:if="${entry.value[0].keywordIsActive}" class="bg-green-200 text-green-600 py-1 px-2 rounded-full text-xs">활성</span>
        <span th:unless="${entry.value[0].keywordIsActive}" class="bg-red-200 text-red-600 py-1 px-2 rounded-full text-xs">비활성</span>)
      </h3>
      <div class="overflow-x-auto">
        <table class="min-w-full bg-white">
          <thead>
          <tr class="bg-gray-100 text-gray-600 uppercase text-xs leading-normal">
            <th class="py-2 px-4 text-left">수신자 ID</th>
            <th class="py-2 px-4 text-left">트위터 ID</th>
            <th class="py-2 px-4 text-left">계정명</th>
            <th class="py-2 px-4 text-left">메모</th>
            <th class="py-2 px-4 text-left">활성 여부</th>
            <th class="py-2 px-4 text-center">액션</th>
          </tr>
          </thead>
          <tbody class="text-gray-600 text-sm font-light">
          <!-- 해당 키워드를 받는 수신자 목록 순회 -->
          <tr th:each="recipientMapping : ${entry.value}" class="border-b border-gray-200 hover:bg-gray-50">
            <td th:text="${recipientMapping.recipientId}" class="py-2 px-4 text-left whitespace-nowrap"></td>
            <td th:text="${recipientMapping.recipientTwitterUserId}" class="py-2 px-4 text-left"></td>
            <td th:text="${recipientMapping.recipientTwitterScreenName}" class="py-2 px-4 text-left"></td>
            <td th:text="${recipientMapping.description}" class="py-2 px-4 text-left"></td>
            <td class="py-2 px-4 text-left">
              <span th:if="${recipientMapping.recipientIsActive}" class="bg-green-200 text-green-600 py-1 px-2 rounded-full text-xs">활성</span>
              <span th:unless="${recipientMapping.recipientIsActive}" class="bg-red-200 text-red-600 py-1 px-2 rounded-full text-xs">비활성</span>
            </td>
            <td class="py-2 px-4 text-center">
              <button class="bg-red-500 hover:bg-red-700 text-white font-bold py-1 px-3 rounded text-xs delete-mapping-btn"
                      th:data-keyword-id="${entry.value[0].keywordId}"
                      th:data-recipient-id="${recipientMapping.recipientId}">
                삭제
              </button>
            </td>
          </tr>
          </tbody>
        </table>
      </div>
    </div>
    <button id="addMappingBtn" class="mt-4 bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
      새 매핑 추가
    </button>
  </div>

  <div class="bg-white shadow-md rounded-lg p-6 mb-8">
    <h2 class="text-2xl font-semibold text-gray-700 mb-4">키워드</h2>
    <div class="overflow-x-auto">
      <table class="min-w-full bg-white border border-gray-300">
        <thead>
        <tr class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
          <th class="py-3 px-6 text-left">ID</th>
          <th class="py-3 px-6 text-left">키워드 텍스트</th>
          <th class="py-3 px-6 text-left">활성 여부</th>
          <th class="py-3 px-6 text-center">액션</th>
        </tr>
        </thead>
        <tbody class="text-gray-600 text-sm font-light">
        <tr th:each="keyword : ${keywords}" class="border-b border-gray-200 hover:bg-gray-100 keyword-row" th:data-id="${keyword.keywordId}" th:data-text="${keyword.keywordText}" th:data-active="${keyword.keywordIsActive}"> <!-- 'keyword-row' 클래스와 data- 속성 추가 -->
          <td th:text="${keyword.keywordId}" class="py-3 px-6 text-left whitespace-nowrap"></td>
          <td th:text="${keyword.keywordText}" class="py-3 px-6 text-left"></td>
          <td class="py-3 px-6 text-left">
            <span th:if="${keyword.keywordIsActive}" class="bg-green-200 text-green-600 py-1 px-3 rounded-full text-xs">활성</span>
            <span th:unless="${keyword.keywordIsActive}" class="bg-red-200 text-red-600 py-1 px-3 rounded-full text-xs">비활성</span>
          </td>
          <td class="py-3 px-6 text-center">
            <button class="bg-yellow-500 hover:bg-yellow-700 text-white font-bold py-1 px-3 rounded text-xs mr-2 update-keyword-btn">수정</button>
            <button class="bg-red-500 hover:bg-red-700 text-white font-bold py-1 px-3 rounded text-xs delete-keyword-btn">삭제</button>
          </td>
        </tr>
        <tr th:if="${keywords.isEmpty()}">
          <td colspan="4" class="py-3 px-6 text-center text-gray-500">등록된 키워드가 없습니다.</td>
        </tr>
        </tbody>
      </table>
    </div>
    <button id="addKeywordBtn" class="mt-4 bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
      새 키워드 추가
    </button>
  </div>

  <div class="bg-white shadow-md rounded-lg p-6">
    <h2 class="text-2xl font-semibold text-gray-700 mb-4">DM 수신자 계정</h2>
    <div class="overflow-x-auto">
      <table class="min-w-full bg-white border border-gray-300">
        <thead>
        <tr class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
          <th class="py-3 px-6 text-left">ID</th>
          <th class="py-3 px-6 text-left">트위터 ID</th>
          <th class="py-3 px-6 text-left">계정명</th>
          <th class="py-3 px-6 text-left">메모</th>
          <th class="py-3 px-6 text-left">활성 여부</th>
          <th class="py-3 px-6 text-center">액션</th>
        </tr>
        </thead>
        <tbody class="text-gray-600 text-sm font-light">
        <tr th:each="recipient : ${recipients}" class="border-b border-gray-200 hover:bg-gray-100 recipient-row" th:data-id="${recipient.recipientId}" th:data-twitter-id="${recipient.recipientTwitterUserId}" th:data-screen-name="${recipient.recipientTwitterScreenName}" th:data-description="${recipient.description}" th:data-active="${recipient.recipientIsActive}"> <!-- 'recipient-row' 클래스와 data- 속성 추가 -->
          <td th:text="${recipient.recipientId}" class="py-3 px-6 text-left whitespace-nowrap"></td>
          <td th:text="${recipient.recipientTwitterUserId}" class="py-3 px-6 text-left"></td>
          <td th:text="${recipient.recipientTwitterScreenName}" class="py-3 px-6 text-left"></td>
          <td th:text="${recipient.description}" class="py-3 px-6 text-left"></td>
          <td class="py-3 px-6 text-left">
            <span th:if="${recipient.recipientIsActive}" class="bg-green-200 text-green-600 py-1 px-3 rounded-full text-xs">활성</span>
            <span th:unless="${recipient.recipientIsActive}" class="bg-red-200 text-red-600 py-1 px-3 rounded-full text-xs">비활성</span>
          </td>
          <td class="py-3 px-6 text-center">
            <button class="bg-yellow-500 hover:bg-yellow-700 text-white font-bold py-1 px-3 rounded text-xs mr-2 update-recipient-btn">수정</button>
            <button class="bg-red-500 hover:bg-red-700 text-white font-bold py-1 px-3 rounded text-xs delete-recipient-btn">삭제</button>
          </td>
        </tr>
        <tr th:if="${recipients.isEmpty()}">
          <td colspan="5" class="py-3 px-6 text-center text-gray-500">등록된 수신자 계정이 없습니다.</td>
        </tr>
        </tbody>
      </table>
    </div>
    <button id="addRecipientBtn" class="mt-4 bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">
      새 수신자 추가
    </button>
  </div>
</div>
<div id="modalContainer" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50">
  <div class="bg-white p-8 rounded-lg shadow-xl max-w-md w-full">
    <h2 id="modalTitle" class="text-2xl font-bold mb-6 text-gray-800"></h2>
    <form id="modalForm" class="space-y-4">
    </form>
    <div class="mt-6 flex justify-end space-x-3">
      <button id="modalSubmitBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
        저장
      </button>
      <button id="modalCloseBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded">
        취소
      </button>
    </div>
  </div>
</div>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script>
  $(document).ready(function () {

    const modalContainer = $('#modalContainer');
    const modalTitle = $('#modalTitle');
    const modalForm = $('#modalForm');
    const modalSubmitBtn = $('#modalSubmitBtn');
    const modalCloseBtn = $('#modalCloseBtn');

    let currentAction = ''; // 'add-keyword', 'update-keyword' 등 현재 모달의 동작
    let currentRecordId = null; // 수정 시 사용할 ID

    // 모달 열기 함수
    function openModal(title, fieldsHtml, actionType, recordId = null) {
      modalTitle.text(title);
      modalForm.html(fieldsHtml);
      modalSubmitBtn.text(recordId ? '수정' : '추가'); // 버튼 텍스트 변경
      modalContainer.removeClass('hidden').addClass('flex'); // 모달 보이게
      currentAction = actionType;
      currentRecordId = recordId;
    }

    // 모달 닫기 함수
    modalCloseBtn.on('click', function() {
      modalContainer.removeClass('flex').addClass('hidden'); // 모달 숨기기
      modalForm.empty(); // 폼 필드 초기화
      currentAction = '';
      currentRecordId = null;
    });

    // AJAX 요청 후 페이지 새로고침 대신 모달 닫고 알림 메시지 표시
    function handleAjaxResponse(response, actionName) {
      if (response.status === 'success') {
        alert(actionName + " 완료: " + response.message);
        modalCloseBtn.click(); // 모달 닫기
        location.reload(); // 페이지 새로고침 (나중에 동적 업데이트로 변경 가능)
      } else {
        alert(actionName + " 실패: " + response.message);
      }
    }

    $('#addKeywordBtn').on('click', function () {
      const fields = `
                <label class="block text-gray-700 text-sm font-bold mb-2">키워드 텍스트:</label>
                <input type="text" id="keywordText" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                <label class="block mt-4">
                    <input type="checkbox" id="isActive" class="mr-2 leading-tight">
                    <span class="text-sm">활성화</span>
                </label>
            `;
      openModal("새 키워드 추가", fields, "add-keyword");
      $('#isActive').prop('checked', true); // 추가 시 기본 활성
    });

    $('#addRecipientBtn').on('click', function () {
      const fields = `
                <label class="block text-gray-700 text-sm font-bold mb-2">트위터 User ID:</label>
                <input type="number" id="twitterUserId" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                <label class="block text-gray-700 text-sm font-bold mb-2 mt-4">트위터 계정명 (@제외):</label>
                <input type="text" id="twitterScreenName" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                <label class="block text-gray-700 text-sm font-bold mb-2 mt-4">메모 (선택 사항):</label>
                <input type="text" id="description" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                <label class="block mt-4">
                    <input type="checkbox" id="isActive" class="mr-2 leading-tight">
                    <span class="text-sm">활성화</span>
                </label>
            `;
      openModal("새 수신자 추가", fields, "add-recipient");
      $('#isActive').prop('checked', true); // 추가 시 기본 활성
    });

    $('#addMappingBtn').on('click', function () {
      // .keyword-row 클래스를 가진 모든 <tr> 요소에서 data-id와 data-text를 가져옴
      const keywordOptions = Array.from(document.querySelectorAll('.keyword-row')).map(row =>
              `<option value="${row.dataset.id}">${row.dataset.text}</option>`
      ).join('');
      // .recipient-row 클래스를 가진 모든 <tr> 요소에서 data-id와 data-screen-name을 가져옴
      const recipientOptions = Array.from(document.querySelectorAll('.recipient-row')).map(row =>
              `<option value="${row.dataset.id}">${row.dataset.screenName}</option>`
      ).join('');

      const fields = `
                <label class="block text-gray-700 text-sm font-bold mb-2">키워드 선택:</label>
                <select id="keywordId" class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                    <option value="">키워드를 선택하세요</option>
                    ${keywordOptions}
                </select>
                <label class="block text-gray-700 text-sm font-bold mb-2 mt-4">수신자 선택:</label>
                <select id="recipientId" class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                    <option value="">수신자를 선택하세요</option>
                    ${recipientOptions}
                </select>
            `;
      openModal("새 매핑 추가", fields, "add-mapping");
    });

    $('.update-keyword-btn').on('click', function() {
      const row = $(this).closest('tr');
      const id = row.data('id');
      const currentText = row.data('text');
      const currentActive = row.data('active');

      const fields = `
                <label class="block text-gray-700 text-sm font-bold mb-2">키워드 ID:</label>
                <input type="text" id="keywordIdDisplay" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline bg-gray-200" value="${id}" readonly>
                <label class="block text-gray-700 text-sm font-bold mb-2 mt-4">키워드 텍스트:</label>
                <input type="text" id="keywordText" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" value="${currentText}" required>
                <label class="block mt-4">
                    <input type="checkbox" id="isActive" class="mr-2 leading-tight">
                    <span class="text-sm">활성화</span>
                </label>
            `;
      openModal("키워드 수정", fields, "update-keyword", id);
      $('#isActive').prop('checked', currentActive);
    });

    $('.update-recipient-btn').on('click', function() {
      const row = $(this).closest('tr');
      const id = row.data('id');
      const currentTwitterId = row.data('twitter-id');
      const currentScreenName = row.data('screen-name');
      const currentDescription = row.data('description');
      const currentActive = row.data('active');

      const fields = `
                <label class="block text-gray-700 text-sm font-bold mb-2">수신자 ID:</label>
                <input type="text" id="recipientIdDisplay" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline bg-gray-200" value="${id}" readonly>
                <label class="block text-gray-700 text-sm font-bold mb-2 mt-4">트위터 User ID:</label>
                <input type="number" id="twitterUserId" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" value="${currentTwitterId}" required>
                <label class="block text-gray-700 text-sm font-bold mb-2 mt-4">트위터 계정명 (@제외):</label>
                <input type="text" id="twitterScreenName" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" value="${currentScreenName}" required>
                <label class="block text-gray-700 text-sm font-bold mb-2 mt-4">메모 (선택 사항):</label>
                <input type="text" id="description" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" value="${currentDescription || ''}">
                <label class="block mt-4">
                    <input type="checkbox" id="isActive" class="mr-2 leading-tight">
                    <span class="text-sm">활성화</span>
                </label>
            `;
      openModal("수신자 수정", fields, "update-recipient", id);
      $('#isActive').prop('checked', currentActive);
    });

    $('.delete-keyword-btn').on('click', function() {
      const id = $(this).data('id');
      if (confirm("정말로 키워드 ID " + id + "를 삭제하시겠습니까?")) {
        $.ajax({
          url: '/admin/keywords/' + id,
          type: 'DELETE',
          success: function(response) {
            handleAjaxResponse(response, "키워드 삭제");
          },
          error: function(xhr) {
            alert("키워드 삭제 실패: " + xhr.responseText);
          }
        });
      }
    });

    $('.delete-recipient-btn').on('click', function() {
      const id = $(this).data('id');
      if (confirm("정말로 수신자 ID " + id + "를 삭제하시겠습니까?")) {
        $.ajax({
          url: '/admin/recipients/' + id,
          type: 'DELETE',
          success: function(response) {
            handleAjaxResponse(response, "수신자 삭제");
          },
          error: function(xhr) {
            alert("수신자 삭제 실패: " + xhr.responseText);
          }
        });
      }
    });

    $('.delete-mapping-btn').on('click', function() {
      const keywordId = $(this).data('keyword-id');
      const recipientId = $(this).data('recipient-id');
      if (confirm("정말로 키워드 ID " + keywordId + "와 수신자 ID " + recipientId + "의 매핑을 삭제하시겠습니까?")) {
        $.ajax({
          url: '/admin/mappings/' + keywordId + '/' + recipientId,
          type: 'DELETE',
          success: function(response) {
            handleAjaxResponse(response, "매핑 삭제");
          },
          error: function(xhr) {
            alert("매핑 삭제 실패: " + xhr.responseText);
          }
        });
      }
    });

    modalSubmitBtn.on('click', function() {
      let data = {};
      let url = '';
      let type = '';
      let actionName = '';

      if (currentAction === 'add-keyword' || currentAction === 'update-keyword') {
        const keywordText = $('#keywordText').val();
        const isActive = $('#isActive').is(':checked');
        if (!keywordText) { alert('키워드 텍스트는 필수입니다.'); return; }
        data = { keywordText: keywordText, isActive: isActive };
        url = '/admin/keywords';
        type = currentAction === 'add-keyword' ? 'POST' : 'PUT';
        actionName = currentAction === 'add-keyword' ? '키워드 추가' : '키워드 수정';
        if (currentAction === 'update-keyword') {
          data.id = currentRecordId;
          url += '/' + currentRecordId;
        }
      } else if (currentAction === 'add-recipient' || currentAction === 'update-recipient') {
        const twitterUserId = $('#twitterUserId').val();
        const twitterScreenName = $('#twitterScreenName').val();
        const description = $('#description').val();
        const isActive = $('#isActive').is(':checked');
        if (!twitterUserId || !twitterScreenName) { alert('트위터 User ID와 계정명은 필수입니다.'); return; }
        data = {
          twitterUserId: parseInt(twitterUserId),
          twitterScreenName: twitterScreenName,
          description: description,
          isActive: isActive
        };
        url = '/admin/recipients';
        type = currentAction === 'add-recipient' ? 'POST' : 'PUT';
        actionName = currentAction === 'add-recipient' ? '수신자 추가' : '수신자 수정';
        if (currentAction === 'update-recipient') {
          data.id = currentRecordId;
          url += '/' + currentRecordId;
        }
      } else if (currentAction === 'add-mapping') {
        const keywordId = $('#keywordId').val();
        const recipientId = $('#recipientId').val();
        if (!keywordId || !recipientId) { alert('키워드와 수신자를 선택하세요.'); return; }
        data = { keywordId: parseInt(keywordId), recipientId: parseInt(recipientId) };
        url = '/admin/mappings';
        type = 'POST';
        actionName = '매핑 추가';
      }

      $.ajax({
        url: url,
        type: type,
        contentType: 'application/json',
        data: JSON.stringify(data),
        success: function(response) {
          handleAjaxResponse(response, actionName);
        },
        error: function(xhr) {
          alert(actionName + " 실패: " + xhr.responseText);
        }
      });
    });
  });
</script>